<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>threejs</title>
  <style>
    body { margin: 0; }
    canvas { display: block; }
  </style>
  <!-- åŠ åœ¨ <head> è£¡å³å¯ -->
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.skypack.dev/three@0.150.1"
  }
}
</script>

</head>
<body>
  <!-- è­¦å‘Šè¨Šæ¯ -->
  <div id="warning" style="position:absolute;top:20px;left:50%;transform:translateX(-50%);background:red;color:white;padding:10px 20px;font-size:20px;font-weight:bold;border-radius:5px;display:none;"></div>
  
  <!-- æ™‚é–“èˆ‡é€Ÿåº¦é¡¯ç¤º -->
  <div id="timeDisplay" style="position:absolute;top:10px;right:10px;background:rgba(0,0,0,0.6);color:white;padding:8px 12px;border-radius:5px;font-family:monospace;font-size:16px;z-index:10;">Time: 0.00s</div>
  <div id="speedDisplay" style="position:absolute;top:50px;right:10px;background:rgba(0,0,0,0.6);color:white;padding:8px 12px;border-radius:5px;font-family:monospace;font-size:16px;z-index:10;">Speed: 0.00</div>
<div id="etaDisplay" style="position:absolute;top:90px;right:10px;background:rgba(0,0,0,0.6);color:white;padding:8px 12px;border-radius:5px;font-family:monospace;font-size:16px;z-index:10;">é ä¼°é€²å…¥è­¦ç¤ºå€åŸŸæ™‚é–“: -- s</div>

  <!-- æ§åˆ¶å€ -->
  <div style="position:absolute;bottom:10px;left:10px;z-index:10;">
    <button id="playBtn">â–¶ æ’­æ”¾</button>
    <button id="pauseBtn">â¸ æš«åœ</button>
    <button id="resetBtn">ğŸ”„ é‡è£½</button>
  </div>

  <!-- è»Šé€Ÿè¼¸å…¥ -->
  <div style="position:absolute;bottom:140px;left:10px;background:rgba(255,255,255,0.9);padding:10px;border-radius:5px;z-index:10;">
    <label>è»Šé€Ÿ v (m/s)ï¼š</label>
    <input id="speedInput" type="number" step="0.1" value="2.5" style="width:60px;" />
    <button id="setSpeedBtn">è¨­å®š</button>
  </div>

  <!-- é€Ÿç‡åœ–ä¾‹ -->
  <div id="speedLegend" style="position:absolute;bottom:10px;right:10px;background:rgba(0,0,0,0.7);color:white;padding:10px;border-radius:10px;font-family:monospace;font-size:14px;line-height:1.5;z-index:10;">
    <div><span style="color:#00ffff">â—</span> < 10 </div>
    <div><span style="color:#00ff00">â—</span> < 20</div>
    <div><span style="color:#ffff00">â—</span> < 30</div>
    <div><span style="color:#ffa500">â—</span> < 40</div>
    <div><span style="color:#ff0000">â—</span> < 50</div>
    <div><span style="color:#8b0000">â—</span> â‰¥ 50 </div>
  </div>

  <!-- è¡Œäººè·¯ç·šåˆ‡æ› -->
  <div style="position:absolute;bottom:60px;left:10px;z-index:10;">
    <label><input type="radio" name="pedestrianRoute" value="default" checked> é è¨­è·¯ç·š</label><br>
    <label><input type="radio" name="pedestrianRoute" value="object"> å°å‘è¡Œäºº</label><br>
    <label><input type="radio" name="pedestrianRoute" value="wander"> è‡ªç”±è¡Œäºº</label>
  </div>

  <script type="module">
    import * as THREE from 'https://esm.sh/three@0.150.1';
import { GLTFLoader } from 'https://esm.sh/three@0.150.1/examples/jsm/loaders/GLTFLoader.js';


    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xa0a0a0);

    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    //  camera.position.set(15, 15, 15);
    // camera.lookAt(-10, 0, 10);
    camera.position.set(0, 50, 0);
      camera.lookAt(0, 0, 0);
      camera.up.set(0, 0, 1);

    const renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const ground = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.MeshBasicMaterial({ color: 0xcccccc }));
    ground.rotation.x = -Math.PI / 2;
    scene.add(ground);

    const dangerArea = new THREE.Mesh(new THREE.BoxGeometry(1.75, 0.2, 4.63), new THREE.MeshBasicMaterial({ color: 0xff0000, transparent: true, opacity: 0.3 }));
    scene.add(dangerArea);

    const collisionArea = new THREE.Mesh(new THREE.CircleGeometry(1, 32), new THREE.MeshBasicMaterial({ color: 0xffaa00, transparent: true, opacity: 0.3 }));
    collisionArea.rotation.x = -Math.PI / 2;
    scene.add(collisionArea);

    const pedestrianPath = [], carPath = [], pedestriansFromObject = [], pedestriansWandering = [];
    pedestriansFromObject.push({ id: 'fromObject1', position: new THREE.Vector3(0, 0.1, 15), direction: new THREE.Vector3(1, 0, -1).normalize(), speed: 0.01});
    pedestriansWandering.push({ id: 'wanderer1', position: new THREE.Vector3(0, 0.1, 20), direction: new THREE.Vector3(Math.random() - 0.5, 0, Math.random() - 0.5).normalize(), speed: 0.01, changeTimer: 0 });

    let isPlaying = false, selectedRoute = 'default', time = 0, carDistance = 0;
    let carSpeed = parseFloat(document.getElementById("speedInput").value);
const loader = new GLTFLoader();
let carModel;

loader.load('./model/toyota_corolla_altis_stance.glb', gltf => {
  carModel = gltf.scene;
  carModel.scale.set(0.01, 0.01, 0.01); // å…ˆç¸®å°çœ‹çœ‹
  carModel.position.set(2, 0.1, -30);   // èª¿é«˜ä¸€é»
  scene.add(carModel);
  console.log('è¼‰å…¥æˆåŠŸ', carModel);
}, undefined, error => {
  console.error('è¼‰å…¥è»Šè¼›æ¨¡å‹å¤±æ•—:', error);
});
const light = new THREE.DirectionalLight(0xffffff, 1);
light.position.set(10, 10, 10);
scene.add(light);

    const t_safety = 3.5, t_reaction = 1.5, a_brake = 8;

    document.getElementById('playBtn').onclick = () => isPlaying = true;
    document.getElementById('pauseBtn').onclick = () => isPlaying = false;
    document.getElementById('resetBtn').onclick = () => {
  // é‡è¨­æ™‚é–“èˆ‡è·é›¢
  time = 0;
  carDistance = 0;

  // é‡è¨­å‰è»Šç‹€æ…‹
  braking = false;
  brakeTimer = 0;

  // é‡è¨­è»Šé€Ÿï¼ˆè®€å–è¼¸å…¥æ¡†æœ€æ–°å€¼ï¼‰
  carSpeed = parseFloat(document.getElementById("speedInput").value) || 0;

  // é‡è¨­è¡Œäººä½ç½®ï¼ˆä¾æœ€åˆå®£å‘Šçš„åˆå§‹ä½ç½®ï¼‰
  pedestriansFromObject[0].position.set(0, 0.1, 15);
  pedestriansWandering[0].position.set(0, 0.1, 20);
  pedestriansWandering[0].changeTimer = 0;

  // æ¸…é™¤è¡Œäººè»Œè·¡çš„æ¨™è¨˜çƒ
  [...scene.children].forEach(obj => {
    if (obj.isMesh && obj.geometry.type === 'SphereGeometry') {
      scene.remove(obj);
    }
  });

  // é‡è¨­é¡¯ç¤ºæ–‡å­—
  document.getElementById('timeDisplay').innerText = `æ¨¡æ“¬ç§’æ•¸: 0.00s`;
  document.getElementById('speedDisplay').innerText = `Speed: ${carSpeed.toFixed(2)} m/s`;
  document.getElementById("etaDisplay").innerText = "ETA: -- s";

  // éš±è—è­¦å‘Š
  document.getElementById("warning").style.display = "none";
};


    document.getElementById('setSpeedBtn').onclick = () => {
      const inputVal = parseFloat(document.getElementById("speedInput").value);
      if (!isNaN(inputVal) && inputVal >= 0) carSpeed = inputVal;
    };

    document.querySelectorAll('input[name="pedestrianRoute"]').forEach(r => {
  r.addEventListener('change', e => {
    selectedRoute = e.target.value;

    // é‡è¨­æ¨¡æ“¬æ™‚é–“èˆ‡è»Šè·
    time = carDistance = 0;

    // é‡è¨­è¡Œäººä½ç½®
    pedestriansFromObject[0].position.set(0, 0.1, 15);
    pedestriansWandering[0].position.set(0, 0.1, 20);
    pedestriansWandering[0].changeTimer = 0;

    // æ¸…é™¤æ¨™è¨˜çƒ
    [...scene.children].forEach(obj => {
      if (obj.isMesh && obj.geometry.type === 'SphereGeometry') {
        scene.remove(obj);
      }
    });

    // æ¸…ç©ºè»Œè·¡
    pedestrianPath.length = 0;
    carPath.length = 0;

    // é‡è¨­æ™‚é–“é¡¯ç¤ºèˆ‡è­¦ç¤º
    document.getElementById('timeDisplay').innerText = `æ¨¡æ“¬ç§’æ•¸: 0.00s`;
    document.getElementById("warning").style.display = "none";
  });
});


    function createMarker(x, y, z, color = 0xffff00) {
      const marker = new THREE.Mesh(new THREE.SphereGeometry(0.2, 16, 16), new THREE.MeshBasicMaterial({ color }));
      marker.position.set(x, y, z);
      scene.add(marker);
    }

    function isInsideEllipse(px, pz, cx, cz, rx, rz) {
      const dx = px - cx, dz = pz - cz;
      return (dx * dx) / (rx * rx) + (dz * dz) / (rz * rz) <= 1;
    }

    function isInsideBox(px, pz, cx, cz, hx, hz) {
      return Math.abs(px - cx) <= hx && Math.abs(pz - cz) <= hz;
    }

    function getColorBySpeed(speed) {
  if (speed < 10) return '#00ffff'; // é’è‰²
  if (speed < 20) return '#00ff00'; // ç¶ 
  if (speed < 30) return '#ffff00'; // é»ƒ
  if (speed < 40) return '#ffa500'; // æ©˜
  if (speed < 50) return '#ff0000'; // ç´…
  return '#8b0000'; // æ·±ç´…
}
function computeETAtoEllipse(pedPos, pedDir, pedSpeed, ellipseCenter, ellipseA, ellipseB) {
  const dx = pedPos.x - ellipseCenter.x;
  const dz = pedPos.z - ellipseCenter.z;
  const vx = pedDir.x * pedSpeed;
  const vz = pedDir.z * pedSpeed;

  const A = (vx * vx) / (ellipseA * ellipseA) + (vz * vz) / (ellipseB * ellipseB);
  const B = 2 * ((dx * vx) / (ellipseA * ellipseA) + (dz * vz) / (ellipseB * ellipseB));
  const C = (dx * dx) / (ellipseA * ellipseA) + (dz * dz) / (ellipseB * ellipseB) - 1;

  const discriminant = B * B - 4 * A * C;

  if (discriminant < 0 || A === 0) return null;

  const sqrtD = Math.sqrt(discriminant);
  const t1 = (-B - sqrtD) / (2 * A);
  const t2 = (-B + sqrtD) / (2 * A);

  const tEntry = Math.min(t1, t2);
  if (tEntry >= 0) return tEntry;
  if (Math.max(t1, t2) >= 0) return 0; // å·²é€²å…¥æ©¢åœ“
  return null; // ä¸æœƒé€²å…¥
}

let braking = false;       // æ˜¯å¦æ­£åœ¨å‰è»Š
let brakeTimer = 0;        // å‰è»Šè¨ˆæ™‚å™¨

function animate() {
  requestAnimationFrame(animate);


  if (!isPlaying) return renderer.render(scene, camera);
console.log(isPlaying);
  time += 0.01;
  document.getElementById('timeDisplay').innerText = `æ¨¡æ“¬ç§’æ•¸: ${time.toFixed(2)}s`;

  const warningDiv = document.getElementById("warning");
  warningDiv.style.display = "none";

  const carX = 2;
  
  // å¦‚æœå‰è»Šä¸­ï¼Œé€Ÿåº¦é€æ¼¸æ¸›å°‘
  if (braking) {
    brakeTimer += 0.01;
    // å‰è»Šæ™‚é–“ç¸½é•·åº¦
    const t_total = t_reaction + carSpeed / a_brake;
    // ä¾å‰è»Šæ™‚é–“èª¿æ•´é€Ÿåº¦ï¼ˆç·šæ€§é™é€Ÿï¼‰
    carSpeed = Math.max(0, carSpeed * (1 - brakeTimer / t_total));
    if (carSpeed === 0) {
      // å‰è»Šå®Œæˆï¼Œåœæ­¢
      isPlaying = false;
      warningDiv.innerText = "è»Šè¼›å·²å®Œå…¨å‰è»Šï¼";
      warningDiv.style.background = "red";
      warningDiv.style.display = "block";
    }
  }

  carDistance += carSpeed * 0.01;
  let carZ = time < 0.01 ? -30 : -30 + carDistance;
  if (carModel) {
  carModel.position.set(1.25, 0.1, 2.5+carZ);  // æ ¹æ“šè»Šé€Ÿæ›´æ–° Z åº§æ¨™
}
  document.getElementById('speedDisplay').innerText = `Speed: ${carSpeed.toFixed(2)} m/s`;

  const safeDistance = carSpeed * t_safety + (carSpeed * carSpeed) / (2 * a_brake);
  const scaleZ = Math.max(1, safeDistance);

  collisionArea.scale.set(1, scaleZ, 1);
  collisionArea.position.set(carX, 0.05, carZ);
  dangerArea.position.set(carX, 0.1, carZ);
  collisionArea.material.color.set(getColorBySpeed(carSpeed));

  // åˆ¤æ–·æ˜¯å¦æœ‰è¡Œäººé€²å…¥æ©¢åœ“å€ï¼Œè§¸ç™¼å‰è»Š
  let isPedestrianInEllipse = false;

  // ä½ åŸæœ¬çš„åˆ¤æ–·ç¨‹å¼è£¡ï¼Œè«‹æŠŠã€Œæ©¢åœ“å€åˆ¤æ–·ã€æ”¹æˆä¸‹é¢çš„åŒæ™‚è¨­å®šè®Šæ•¸
  function checkPedestrian(x, z) {
    if (isInsideEllipse(x, z, carX, carZ, 1, scaleZ)) {
      isPedestrianInEllipse = true;
      return true;
    }
    return false;
  }

  if (selectedRoute === 'default') {
    let pedX = -50, pedZ = time + 0.1;
    if (time >= 0) pedX = time * (1 / 3);
    const pedPos = new THREE.Vector3(pedX, 0.1, pedZ);
    createMarker(pedPos.x, pedPos.y, pedPos.z, 0xff0000);

    const pedDir = new THREE.Vector3(1, 0, 3).normalize();
    const pedSpeed = Math.sqrt(1*1 + (1/3)*(1/3));
    const eta = computeETAtoEllipse(pedPos, pedDir, pedSpeed, new THREE.Vector3(carX, 0, carZ), 1, scaleZ);
    document.getElementById("etaDisplay").innerText = `é ä¼°é€²å…¥è­¦ç¤ºå€åŸŸæ™‚é–“: ${eta !== null ? eta.toFixed(2) + ' s' : '--'}`;

    if (isInsideBox(pedX, pedZ, carX, carZ, 1, 1)) {
       
      warningDiv.innerText = "ç¢°æ’ï¼ˆé è¨­è¡Œäººï¼‰ï¼";
      warningDiv.style.background = "red";
      warningDiv.style.display = "block";
      isPlaying = false;
      console.log("ty412");
      return;
    } else if (checkPedestrian(pedX, pedZ)) {
      warningDiv.innerText = "è­¦ç¤ºï¼ˆé è¨­è¡Œäººï¼‰ï¼";
      warningDiv.style.background = "orange";
      warningDiv.style.display = "block";
    }
  }

  if (selectedRoute === 'object') {
    let minETA = null;
    for (let ped of pedestriansFromObject) {
      ped.position.addScaledVector(ped.direction, ped.speed);
      createMarker(ped.position.x, ped.position.y, ped.position.z, 0x00ff00);

      const eta = computeETAtoEllipse(
        ped.position,
        ped.direction,
        ped.speed,
        new THREE.Vector3(carX, 0, carZ),
        1,
        scaleZ  
      );
      if (eta !== null && (minETA === null || eta < minETA)) minETA = eta;

      if (isInsideBox(ped.position.x, ped.position.z, carX, carZ, 1, 1)) {
        warningDiv.innerText = "ç¢°æ’ï¼ˆå›ºå®šè·¯ç·šï¼‰ï¼";
        warningDiv.style.background = "red";
        warningDiv.style.display = "block";
      } else if (checkPedestrian(ped.position.x, ped.position.z)) {
        warningDiv.innerText = "è­¦ç¤ºï¼ˆå›ºå®šè·¯ç·šï¼‰ï¼";
        warningDiv.style.background = "orange";
        warningDiv.style.display = "block";
      }
    }
    document.getElementById("etaDisplay").innerText = `é ä¼°é€²å…¥è­¦ç¤ºå€åŸŸæ™‚é–“: ${minETA !== null ? minETA.toFixed(2) + ' s' : '--'}`;
  }

  if (selectedRoute === 'wander') {
    let minETA = null;
    for (let ped of pedestriansWandering) {
      ped.changeTimer += 0.01;
      if (ped.changeTimer > 1.5) {
        ped.direction = new THREE.Vector3(Math.random() - 0.5, 0, Math.random() - 0.5).normalize();
        ped.changeTimer = 0;
      }
      ped.position.addScaledVector(ped.direction, ped.speed);
      createMarker(ped.position.x, ped.position.y, ped.position.z, 0x00ffff);

      const eta = computeETAtoEllipse(
        ped.position,
        ped.direction,
        ped.speed,
        new THREE.Vector3(carX, 0, carZ),
        1,
        scaleZ
      );
      if (eta !== null && (minETA === null || eta < minETA)) minETA = eta;

      if (isInsideBox(ped.position.x, ped.position.z, carX, carZ, 1, 1)) {
        warningDiv.innerText = "ç¢°æ’ï¼ˆè‡ªç”±è¡Œäººï¼‰ï¼";
        warningDiv.style.background = "red";
        warningDiv.style.display = "block";
      } else if (checkPedestrian(ped.position.x, ped.position.z)) {
        warningDiv.innerText = "è­¦ç¤ºï¼ˆè‡ªç”±è¡Œäººï¼‰ï¼";
        warningDiv.style.background = "orange";
        warningDiv.style.display = "block";
      }
    }
    document.getElementById("etaDisplay").innerText = `é ä¼°é€²å…¥è­¦ç¤ºå€åŸŸæ™‚é–“: ${minETA !== null ? minETA.toFixed(2) + ' s' : '--'}`;
  }

  // è§¸ç™¼å‰è»Šæ¢ä»¶
  if (isPedestrianInEllipse && !braking) {
    braking = true;
    brakeTimer = 0;
  }

  renderer.render(scene, camera);
}

    animate();
  </script>
</body>
</html>
