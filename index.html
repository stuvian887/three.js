<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>threejs</title>
  <style>
    body { margin: 0; }
    canvas { display: block; }
  </style>
</head>
<body>
  <!-- 警告訊息 -->
  <div id="warning" style="position:absolute;top:20px;left:50%;transform:translateX(-50%);background:red;color:white;padding:10px 20px;font-size:20px;font-weight:bold;border-radius:5px;display:none;"></div>

  <!-- 時間與速度顯示 -->
  <div id="timeDisplay" style="position:absolute;top:10px;right:10px;background:rgba(0,0,0,0.6);color:white;padding:8px 12px;border-radius:5px;font-family:monospace;font-size:16px;z-index:10;">Time: 0.00s</div>
  <div id="speedDisplay" style="position:absolute;top:40px;right:10px;background:rgba(0,0,0,0.6);color:white;padding:8px 12px;border-radius:5px;font-family:monospace;font-size:16px;z-index:10;">Speed: 0.00</div>

  <!-- 控制區 -->
  <div style="position:absolute;bottom:10px;left:10px;z-index:10;">
    <button id="playBtn">▶ 播放</button>
    <button id="pauseBtn">⏸ 暫停</button>
    <button id="resetBtn">🔄 重製</button>
  </div>

  <!-- 車速輸入 -->
  <div style="position:absolute;bottom:140px;left:10px;background:rgba(255,255,255,0.9);padding:10px;border-radius:5px;z-index:10;">
    <label>車速 v (m/s)：</label>
    <input id="speedInput" type="number" step="0.1" value="2.5" style="width:60px;" />
    <button id="setSpeedBtn">設定</button>
  </div>

  <!-- 速率圖例 -->
  <div id="speedLegend" style="position:absolute;bottom:10px;right:10px;background:rgba(0,0,0,0.7);color:white;padding:10px;border-radius:10px;font-family:monospace;font-size:14px;line-height:1.5;z-index:10;">
    <div><span style="color:#00ffff">●</span> < 10 </div>
    <div><span style="color:#00ff00">●</span> < 20</div>
    <div><span style="color:#ffff00">●</span> < 30</div>
    <div><span style="color:#ffa500">●</span> < 40</div>
    <div><span style="color:#ff0000">●</span> < 50</div>
    <div><span style="color:#8b0000">●</span> ≥ 50 </div>
  </div>

  <!-- 行人路線切換 -->
  <div style="position:absolute;bottom:60px;left:10px;z-index:10;">
    <label><input type="radio" name="pedestrianRoute" value="default" checked> 預設路線</label><br>
    <label><input type="radio" name="pedestrianRoute" value="object"> 物件行人</label><br>
    <label><input type="radio" name="pedestrianRoute" value="wander"> 自由行人</label>
  </div>

  <script type="module">
    import * as THREE from 'https://cdn.skypack.dev/three@0.150.1';

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xa0a0a0);

    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.set(0, 50, 0);
      camera.lookAt(0, 0, 0);
      camera.up.set(0, 0, 1);


    const renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const ground = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.MeshBasicMaterial({ color: 0xcccccc }));
    ground.rotation.x = -Math.PI / 2;
    scene.add(ground);

    const dangerArea = new THREE.Mesh(new THREE.BoxGeometry(2, 0.2, 2), new THREE.MeshBasicMaterial({ color: 0xff0000, transparent: true, opacity: 0.3 }));
    scene.add(dangerArea);

    const collisionArea = new THREE.Mesh(new THREE.CircleGeometry(1, 32), new THREE.MeshBasicMaterial({ color: 0xffaa00, transparent: true, opacity: 0.3 }));
    collisionArea.rotation.x = -Math.PI / 2;
    scene.add(collisionArea);

    const pedestrianPath = [], carPath = [], pedestriansFromObject = [], pedestriansWandering = [];
    pedestriansFromObject.push({ id: 'fromObject1', position: new THREE.Vector3(0, 0.1, 15), direction: new THREE.Vector3(1, 0, -1).normalize(), speed: 0.02 });
    pedestriansWandering.push({ id: 'wanderer1', position: new THREE.Vector3(0, 0.1, 20), direction: new THREE.Vector3(Math.random() - 0.5, 0, Math.random() - 0.5).normalize(), speed: 0.01, changeTimer: 0 });

    let isPlaying = false, selectedRoute = 'default', time = 0, carDistance = 0;
    let carSpeed = parseFloat(document.getElementById("speedInput").value);

    const t_safety = 3.5, t_reaction = 1.5, a_brake = 8;

    document.getElementById('playBtn').onclick = () => isPlaying = true;
    document.getElementById('pauseBtn').onclick = () => isPlaying = false;
    document.getElementById('resetBtn').onclick = () => {
      pedestriansFromObject[0].position.set(0, 0.1, 15);
      pedestriansWandering[0].position.set(5, 0.1, -5);
      time = carDistance = 0;
      document.getElementById('timeDisplay').innerText = `模擬秒數: 0.00s`;
      pedestrianPath.length = carPath.length = 0;
      [...scene.children].forEach(obj => {
        if (obj.isMesh && obj.geometry.type === 'SphereGeometry') scene.remove(obj);
      });
      document.getElementById("warning").style.display = "none";
    };

    document.getElementById('setSpeedBtn').onclick = () => {
      const inputVal = parseFloat(document.getElementById("speedInput").value);
      if (!isNaN(inputVal) && inputVal >= 0) carSpeed = inputVal;
    };

    document.querySelectorAll('input[name="pedestrianRoute"]').forEach(r => {
  r.addEventListener('change', e => {
    selectedRoute = e.target.value;

    // 重設模擬時間與車距
    time = carDistance = 0;

    // 重設行人位置
    pedestriansFromObject[0].position.set(0, 0.1, 15);
    pedestriansWandering[0].position.set(0, 0.1, 20);
    pedestriansWandering[0].changeTimer = 0;

    // 清除標記球
    [...scene.children].forEach(obj => {
      if (obj.isMesh && obj.geometry.type === 'SphereGeometry') {
        scene.remove(obj);
      }
    });

    // 清空軌跡
    pedestrianPath.length = 0;
    carPath.length = 0;

    // 重設時間顯示與警示
    document.getElementById('timeDisplay').innerText = `模擬秒數: 0.00s`;
    document.getElementById("warning").style.display = "none";
  });
});


    function createMarker(x, y, z, color = 0xffff00) {
      const marker = new THREE.Mesh(new THREE.SphereGeometry(0.2, 16, 16), new THREE.MeshBasicMaterial({ color }));
      marker.position.set(x, y, z);
      scene.add(marker);
    }

    function isInsideEllipse(px, pz, cx, cz, rx, rz) {
      const dx = px - cx, dz = pz - cz;
      return (dx * dx) / (rx * rx) + (dz * dz) / (rz * rz) <= 1;
    }

    function isInsideBox(px, pz, cx, cz, hx, hz) {
      return Math.abs(px - cx) <= hx && Math.abs(pz - cz) <= hz;
    }

    function getColorBySpeed(speed) {
  if (speed < 10) return '#00ffff'; // 青色
  if (speed < 20) return '#00ff00'; // 綠
  if (speed < 30) return '#ffff00'; // 黃
  if (speed < 40) return '#ffa500'; // 橘
  if (speed < 50) return '#ff0000'; // 紅
  return '#8b0000'; // 深紅
}


    function animate() {
      requestAnimationFrame(animate);
      if (!isPlaying) return renderer.render(scene, camera);

      time += 0.01;
      document.getElementById('timeDisplay').innerText = `模擬秒數: ${time.toFixed(2)}s`;

      const warningDiv = document.getElementById("warning");
      warningDiv.style.display = "none";

      const carX = 2;
      carDistance += carSpeed * 0.01;
      const carZ = carDistance;
      document.getElementById('speedDisplay').innerText = `Speed: ${carSpeed.toFixed(2)} m/s`;

      const safeDistance = carSpeed * t_safety + (carSpeed * carSpeed) / (2 * a_brake);
      const scaleZ = Math.max(1, safeDistance);

      collisionArea.scale.set(1, scaleZ, 1);
      collisionArea.position.set(carX, 0.05, carZ);
      dangerArea.position.set(carX, 0.1, carZ);
      collisionArea.material.color.set(getColorBySpeed(carSpeed));

      if (selectedRoute === 'default') {
        let pedX = 0, pedZ = time + 10;
        if (time >= 0) pedX = time  * (1 / 3);
        const pedPos = new THREE.Vector3(pedX, 0.1, pedZ);
        createMarker(pedPos.x, pedPos.y, pedPos.z, 0xff0000);
        if (isInsideBox(pedX, pedZ, carX, carZ, 1, 1)) {
          warningDiv.innerText = "碰撞（預設行人）！";
          warningDiv.style.background = "red";
          warningDiv.style.display = "block";
        } else if (isInsideEllipse(pedX, pedZ, carX, carZ, 1, scaleZ)) {
          warningDiv.innerText = "警示（預設行人）！";
          warningDiv.style.background = "orange";
          warningDiv.style.display = "block";
        }
      }

      if (selectedRoute === 'object') {
        for (let ped of pedestriansFromObject) {
          ped.position.addScaledVector(ped.direction, ped.speed);
          createMarker(ped.position.x, ped.position.y, ped.position.z, 0x00ff00);
          if (isInsideBox(ped.position.x, ped.position.z, carX, carZ, 1, 1)) {
            warningDiv.innerText = "碰撞（固定路線）！";
            warningDiv.style.background = "red";
            warningDiv.style.display = "block";
          } else if (isInsideEllipse(ped.position.x, ped.position.z, carX, carZ, 1, scaleZ)) {
            warningDiv.innerText = "警示（固定路線）！";
            warningDiv.style.background = "orange";
            warningDiv.style.display = "block";
          }
        }
      }

      if (selectedRoute === 'wander') {
        for (let ped of pedestriansWandering) {
          ped.changeTimer += 0.01;
          if (ped.changeTimer > 1.5) {
            ped.direction = new THREE.Vector3(Math.random() - 0.5, 0, Math.random() - 0.5).normalize();
            ped.changeTimer = 0;
          }
          ped.position.addScaledVector(ped.direction, ped.speed);
          createMarker(ped.position.x, ped.position.y, ped.position.z, 0x00ffff);
          if (isInsideBox(ped.position.x, ped.position.z, carX, carZ, 1, 1)) {
            warningDiv.innerText = "碰撞（自由行人）！";
            warningDiv.style.background = "red";
            warningDiv.style.display = "block";
          } else if (isInsideEllipse(ped.position.x, ped.position.z, carX, carZ, 1, scaleZ)) {
            warningDiv.innerText = "警示（自由行人）！";
            warningDiv.style.background = "orange";
            warningDiv.style.display = "block";
          }
        }
      }

      renderer.render(scene, camera);
    }
    animate();
  </script>
</body>
</html>
